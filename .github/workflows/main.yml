name: forge-1.12.2-server
on:
  workflow_dispatch:

jobs:
  minecraft:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 8
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Setup Playit Tunnel
        run: |
          echo "=== Starting Playit ==="
          
          if [ -f playit.toml ] && grep -q "secret_key" playit.toml; then
            SECRET_KEY=$(grep "secret_key" playit.toml | cut -d'"' -f2)
          elif [ -n "${{ secrets.PLAYIT_SECRET_KEY }}" ]; then
            SECRET_KEY="${{ secrets.PLAYIT_SECRET_KEY }}"
          else
            echo "‚ùå No secret_key found!"
            exit 1
          fi
          
          docker run -d \
            --name playit-agent \
            --network host \
            --restart unless-stopped \
            -e SECRET_KEY="$SECRET_KEY" \
            ghcr.io/playit-cloud/playit-agent:latest
          
          sleep 20
          docker logs playit-agent 2>&1 | tail -20
          
          if docker ps | grep -q playit-agent; then
            echo "‚úî Playit active"
          fi
      
      - name: Run Server
        run: |
          echo "=== Starting Server ==="
          
          java -Xmx12G -Xms10G \
            -XX:+UseG1GC \
            -XX:+ParallelRefProcEnabled \
            -XX:MaxGCPauseMillis=200 \
            -XX:+UnlockExperimentalVMOptions \
            -XX:+DisableExplicitGC \
            -XX:+AlwaysPreTouch \
            -XX:G1NewSizePercent=30 \
            -XX:G1MaxNewSizePercent=40 \
            -XX:G1HeapRegionSize=8M \
            -XX:G1ReservePercent=20 \
            -XX:G1HeapWastePercent=5 \
            -XX:G1MixedGCCountTarget=4 \
            -XX:InitiatingHeapOccupancyPercent=15 \
            -XX:G1MixedGCLiveThresholdPercent=90 \
            -XX:G1RSetUpdatingPauseTimePercent=5 \
            -XX:SurvivorRatio=32 \
            -XX:+PerfDisableSharedMem \
            -XX:MaxTenuringThreshold=1 \
            -Dfml.queryResult=confirm \
            -jar *.jar nogui &
          SERVER_PID=$!
          
          echo "‚úî Server started (PID: $SERVER_PID)"
          sleep 60
          
          echo ""
          echo "üéÆ SERVER ONLINE"
          echo ""
          
          MAX_TIME=20700
          ELAPSED=0
          
          while [ $ELAPSED -lt $MAX_TIME ]; do
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              break
            fi
            sleep 30
            ELAPSED=$((ELAPSED + 30))
            if [ $((ELAPSED % 1800)) -eq 0 ]; then
              echo "‚è∞ $((ELAPSED / 60))m"
            fi
          done
          
          if kill -0 $SERVER_PID 2>/dev/null; then
            kill -TERM $SERVER_PID 2>/dev/null || true
            sleep 10
            kill -9 $SERVER_PID 2>/dev/null || true
          fi
          
          docker stop playit-agent 2>/dev/null || true
          docker rm playit-agent 2>/dev/null || true
          echo "‚úî Stopped"
      
      - name: Save changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          
          if ! git diff --cached --quiet 2>/dev/null; then
            git commit -m "Auto-save: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git pull --rebase --autostash origin ${{ github.ref_name }}
            git push origin ${{ github.ref_name }} && echo "‚úî Saved" || echo "‚ö†Ô∏è Push failed"
          fi
      
      - name: Auto-retrigger
        if: github.run_attempt < 3
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          runs=$(gh run list -w forge-1.12.2-server.yml --json status -q \
               '[.[] | select(.status=="queued" or .status=="in_progress")] | length')
          
          if [ "$runs" -le 1 ]; then
            gh workflow run forge-1.12.2-server.yml
            echo "‚úî Retriggered"
          fi
