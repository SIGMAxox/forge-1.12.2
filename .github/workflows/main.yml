name: forge-1.12.2-auto
on:
  workflow_dispatch:

jobs:
  minecraft:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 8
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Download and Install Forge
        run: |
          echo "=== Downloading Forge 1.12.2 ==="
          curl -L -o forge-installer.jar "https://maven.minecraftforge.net/net/minecraftforge/forge/1.12.2-14.23.5.2860/forge-1.12.2-14.23.5.2860-installer.jar"
          
          echo "=== Installing Forge ==="
          java -jar forge-installer.jar --installServer
          
          FORGE_JAR=$(ls forge-*.jar 2>/dev/null | grep -v installer | head -n 1)
          if [ -z "$FORGE_JAR" ]; then
            FORGE_JAR=$(ls minecraft_server.*.jar 2>/dev/null | head -n 1)
          fi
          
          if [ -n "$FORGE_JAR" ]; then
            mv "$FORGE_JAR" forge.jar
            echo "✔ Forge ready"
          else
            echo "❌ Failed"
            exit 1
          fi
          
          rm forge-installer.jar

      - name: Create Config Files
        run: |
          echo "eula=true" > eula.txt
          
          cat > server.properties << 'EOF'
          network-compression-threshold=512
          use-native-transport=true
          snooper-enabled=false
          motd=§6Forge 1.12.2 - Cracked
          server-port=25565
          online-mode=false
          prevent-proxy-connections=false
          view-distance=10
          max-tick-time=60000
          gamemode=0
          difficulty=1
          pvp=true
          allow-flight=false
          level-name=world
          level-type=DEFAULT
          generate-structures=true
          spawn-protection=0
          spawn-npcs=true
          spawn-animals=true
          spawn-monsters=true
          allow-nether=true
          max-players=20
          white-list=false
          enable-command-block=true
          enable-query=false
          enable-rcon=false
          announce-player-achievements=true
          EOF
          
          if [ -n "${{ secrets.PLAYIT_SECRET }}" ]; then
            echo "${{ secrets.PLAYIT_SECRET }}" > playit.toml
          else
            echo 'secret_key = "6eb9988868e8f5d8e1eac21f00e11811a51d9c83a7bfbe17b7a557774f43fcda"' > playit.toml
          fi
          
          mkdir -p mods
          echo "✔ Config ready"

      - name: Setup Playit
        run: |
          curl -SsL https://github.com/playit-cloud/playit-agent/releases/latest/download/playit-linux-amd64 -o playit-linux-amd64
          chmod +x playit-linux-amd64
          
          ./playit-linux-amd64 > playit.log 2>&1 &
          PLAYIT_PID=$!
          sleep 15
          
          if [ -f playit.log ]; then
            echo "=== Playit Info ==="
            tail -20 playit.log
            echo "=================="
          fi
          
          while true; do
            if ! kill -0 $PLAYIT_PID 2>/dev/null; then
              ./playit-linux-amd64 >> playit.log 2>&1 &
              PLAYIT_PID=$!
            fi
            sleep 30
          done &

      - name: Run Server
        run: |
          echo "=== Starting Server ==="
          
          java -Xmx12G -Xms8G \
            -XX:+UseG1GC \
            -XX:+ParallelRefProcEnabled \
            -XX:MaxGCPauseMillis=200 \
            -XX:+UnlockExperimentalVMOptions \
            -XX:+DisableExplicitGC \
            -XX:G1NewSizePercent=30 \
            -XX:G1MaxNewSizePercent=40 \
            -XX:G1HeapRegionSize=8M \
            -XX:G1ReservePercent=20 \
            -XX:InitiatingHeapOccupancyPercent=15 \
            -XX:SurvivorRatio=32 \
            -XX:MaxTenuringThreshold=1 \
            -jar forge.jar nogui &
          SERVER_PID=$!
          
          echo "✔ Server started"
          echo "⏳ Loading (2 min)..."
          sleep 120
          
          echo ""
          echo "=== SERVER ONLINE ==="
          echo "Forge 1.12.2 | Cracked | 5 min test"
          echo ""
          
          REMAINING=180
          while [ $REMAINING -gt 0 ]; do
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              break
            fi
            sleep 30
            REMAINING=$((REMAINING - 30))
            if [ $REMAINING -gt 0 ]; then
              echo "⏰ $((REMAINING / 60))m $((REMAINING % 60))s remaining"
            fi
          done
          
          echo "=== Stopping ==="
          kill -TERM $SERVER_PID 2>/dev/null || true
          sleep 10
          kill -9 $SERVER_PID 2>/dev/null || true
          pkill playit-linux-amd64 2>/dev/null || true
          echo "✔ Done"

      - name: Save Files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          
          if ! git diff --cached --quiet 2>/dev/null; then
            git commit -m "Forge 1.12.2 setup - $(date -u '+%Y-%m-%d %H:%M')"
            git pull --rebase --autostash https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git || true
            
            for i in {1..3}; do
              if git push https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}.git; then
                echo "✔ Saved!"
                break
              fi
              sleep 10
            done
          fi
